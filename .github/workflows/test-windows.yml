name: Test Windows Compatibility

on:
  push:
    paths:
      - 'start.bat'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'api/**'
      - 'softagar/**'
      - 'frontend/**'
  pull_request:
  workflow_dispatch:  # Allows manual triggering

jobs:
  test-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Verify batch file syntax
        shell: cmd
        run: |
          echo Checking start.bat exists and is readable...
          type start.bat > nul
          echo [OK] Batch file is valid
      
      - name: Create and activate virtual environment
        shell: cmd
        run: |
          python -m venv .venv
          call .venv\Scripts\activate.bat
          python --version
          echo [OK] Virtual environment created and activated
      
      - name: Install Python dependencies
        shell: cmd
        run: |
          call .venv\Scripts\activate.bat
          pip install --upgrade pip
          pip install -e ".[api]"
          echo [OK] Python dependencies installed
      
      - name: Verify softagar package
        shell: cmd
        run: |
          call .venv\Scripts\activate.bat
          python -c "import softagar; print('softagar version:', softagar.__version__ if hasattr(softagar, '__version__') else 'ok')"
          python -c "from api.main import app; print('FastAPI app loaded')"
          echo [OK] Package imports work
      
      - name: Build frontend
        shell: cmd
        run: |
          cd frontend
          npm ci
          set VITE_API_BASE_URL=
          npm run build
          echo [OK] Frontend built successfully
      
      - name: Test server startup
        shell: pwsh
        run: |
          # Activate venv in PowerShell
          .\.venv\Scripts\Activate.ps1
          
          # Start server in background
          $job = Start-Job -ScriptBlock {
            Set-Location $using:PWD
            .\.venv\Scripts\Activate.ps1
            uvicorn api.main:app --host 127.0.0.1 --port 8000
          }
          
          # Wait for server to start
          Start-Sleep -Seconds 5
          
          # Test if server responds
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8000" -UseBasicParsing -TimeoutSec 10
            if ($response.StatusCode -eq 200) {
              Write-Host "[OK] Server responds with status 200"
            }
          } catch {
            Write-Host "[WARNING] Server may not have started in time: $_"
          }
          
          # Clean up
          Stop-Job $job -ErrorAction SilentlyContinue
          Remove-Job $job -ErrorAction SilentlyContinue
          
          Write-Host "[OK] Server startup test completed"

